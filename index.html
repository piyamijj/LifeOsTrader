<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piyami PRO Terminal</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #050505; color: #00ff41; margin: 0; padding: 10px; }
        .panel { background: #111; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,255,65,0.1); }
        h2, h3 { margin: 0 0 10px 0; color: #f0b90b; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Radar Listesi */
        .radar-box { list-style: none; padding: 0; margin: 0; font-size: 0.85rem; color: #ddd; }
        .radar-box li::before { content: ">> "; color: #f0b90b; }

        /* Strateji KartlarÄ± */
        .strategy-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .strat-card { background: #000; border: 1px solid #444; padding: 10px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .strat-card:hover { border-color: #f0b90b; box-shadow: 0 0 15px rgba(240, 185, 11, 0.3); }
        .strat-action { font-size: 1.2rem; font-weight: bold; display: block; margin-top: 5px; }
        .buy { color: #0f0; } .sell { color: #f00; } .wait { color: #888; }

        /* Soru Kutusu */
        textarea { width: 100%; background: #222; color: #fff; border: 1px solid #444; padding: 10px; box-sizing: border-box; min-height: 60px; margin-bottom: 10px; font-family: inherit; }
        
        /* Butonlar */
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-run { background: #f0b90b; color: #000; }
        .btn-auto { background: #333; color: #fff; border: 1px solid #555; }
        .btn-auto.active { background: #f00; color: #fff; animation: pulse 1.5s infinite; }

        /* Detay Penceresi (Popup) */
        #tradeModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #000; border: 2px solid #f0b90b; z-index: 100; padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.9); text-align: center; }
        .modal-data { font-size: 1.2rem; margin: 15px 0; line-height: 1.6; }
        .close-btn { background: #333; color: #fff; padding: 5px 10px; cursor: pointer; margin-top: 10px; display: inline-block; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
    </style>
</head>
<body>

    <div class="panel">
        <h2>ğŸ›°ï¸ PÄ°YAMÄ° RADAR</h2>
        <div id="globalStatus" style="color: #00ff41; margin-bottom: 5px;">Sistem HazÄ±r.</div>
        <div id="aiResponse" style="font-size: 0.9rem; color: #ccc; font-style: italic; border-left: 3px solid #f0b90b; padding-left: 10px; margin: 10px 0;">
            "Emirlerinizi bekliyorum komutanÄ±m..."
        </div>
        <ul id="radarElements" class="radar-box"></ul>
    </div>

    <div class="panel">
        <h3>ğŸ¯ OPERASYON MASASI</h3>
        <div class="strategy-grid">
            <div class="strat-card" onclick="showTrade('scalp')">
                SCALP (XAU)<br>
                <span id="sc_action" class="strat-action wait">BEKLE</span>
            </div>
            <div class="strat-card" onclick="showTrade('day')">
                GÃœNLÃœK (EUR)<br>
                <span id="dy_action" class="strat-action wait">BEKLE</span>
            </div>
            <div class="strat-card" onclick="showTrade('swing')">
                SWING (TRY)<br>
                <span id="sw_action" class="strat-action wait">BEKLE</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <textarea id="userQuestion" placeholder="Piyami'ye sor: Trend nereye gidiyor?"></textarea>
        <div class="btn-group">
            <button class="btn-run" onclick="runAnalysis()">ANALÄ°Z ET</button>
            <button class="btn-auto" id="autoBtn" onclick="toggleAuto()">NÃ–BETÃ‡Ä°: KAPALI</button>
        </div>
    </div>

    <div id="tradeModal">
        <h2 style="color:#f0b90b">âš ï¸ Ä°ÅLEM DETAYI</h2>
        <div id="modalContent" class="modal-data">Veri yok...</div>
        <div class="close-btn" onclick="document.getElementById('tradeModal').style.display='none'">KAPAT</div>
    </div>

    <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script>
        let latestData = null;
        let autoInterval = null;

        async function runAnalysis() {
            const btn = document.querySelector('.btn-run');
            const q = document.getElementById('userQuestion').value;
            
            btn.innerText = "VERÄ° ALINIYOR...";
            btn.disabled = true;

            try {
                // Netlify Function'a Soruyla Birlikte Ä°stek At
                const res = await fetch('/api/analiz', {
                    method: 'POST',
                    body: JSON.stringify({ question: q })
                });
                
                const text = await res.text();
                if(!text) throw new Error("BoÅŸ YanÄ±t");
                
                latestData = JSON.parse(text);

                // 1. EkranÄ± GÃ¼ncelle
                document.getElementById('globalStatus').innerText = latestData.globalStatus;
                document.getElementById('aiResponse').innerText = `"${latestData.aiResponse}"`;
                
                const radarUl = document.getElementById('radarElements');
                radarUl.innerHTML = latestData.radarElements.map(e => `<li>${e}</li>`).join('');

                // 2. KartlarÄ± GÃ¼ncelle
                if(latestData.strategies) {
                    updateCard('sc', latestData.strategies.scalp);
                    updateCard('dy', latestData.strategies.day);
                    updateCard('sw', latestData.strategies.swing);
                }

                btn.innerText = "ANALÄ°Z ET";
            } catch (e) {
                alert("Hata: " + e.message);
                btn.innerText = "TEKRAR DENE";
            } finally {
                btn.disabled = false;
            }
        }

        function updateCard(prefix, strategy) {
            const el = document.getElementById(prefix + '_action');
            el.innerText = strategy.action;
            el.className = 'strat-action ' + (strategy.action === 'AL' ? 'buy' : strategy.action === 'SAT' ? 'sell' : 'wait');
            
            // EÄŸer NÃ¶betÃ§i Modu aÃ§Ä±ksa ve AL/SAT sinyali varsa ses Ã§al
            if(autoInterval && (strategy.action === 'AL' || strategy.action === 'SAT')) {
                document.getElementById('alertSound').play();
            }
        }

        function showTrade(type) {
            if(!latestData || !latestData.strategies) {
                alert("Ã–nce analiz yapmalÄ±sÄ±nÄ±z komutanÄ±m!");
                return;
            }
            const s = latestData.strategies[type];
            const modal = document.getElementById('tradeModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <b>PARÄ°TE:</b> ${s.pair}<br>
                <b>YÃ–N:</b> <span style="color:${s.action==='AL'?'#0f0':'#f00'}">${s.action}</span><br>
                ----------------<br>
                <b>GÄ°RÄ°Å:</b> ${s.price}<br>
                <b>HEDEF (TP):</b> ${s.tp}<br>
                <b>STOP (SL):</b> ${s.sl}<br>
            `;
            modal.style.display = 'block';
        }

        function toggleAuto() {
            const btn = document.getElementById('autoBtn');
            if(autoInterval) {
                clearInterval(autoInterval);
                autoInterval = null;
                btn.innerText = "NÃ–BETÃ‡Ä°: KAPALI";
                btn.classList.remove('active');
            } else {
                // 60 saniyede bir otomatik analiz yap
                runAnalysis();
                autoInterval = setInterval(runAnalysis, 60000); 
                btn.innerText = "NÃ–BETÃ‡Ä°: AÃ‡IK";
                btn.classList.add('active');
                alert("NÃ¶betÃ§i Modu Aktif! EkranÄ± aÃ§Ä±k bÄ±rakÄ±n, sinyal gelince sesli uyaracaÄŸÄ±m.");
            }
        }
    </script>
</body>
</html>
